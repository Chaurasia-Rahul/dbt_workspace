{{ config(materialized='incremental',unique_key = ['sales_order_id','sales_order_detail_id'], alias='fact_sales_order') }}

with order_details AS(
select *
from {{ source('stg','salesorderdetail')}}
),
order_header as (
select *
from {{ source('stg','salesorderheader')}}
),
final_table as(
select a.sales_order_id::int
,sales_order_detail_id::int
,carrier_tracking_number:: varchar(30)
,order_qty::int
,product_id::int
,special_offer_id::int
,unit_price::numeric(38,9)
,unit_price_discount::numeric(38,9)
,line_total::numeric(38,9)
,a.modified_date::timestamp
,cast('01/01/1999' as date)::timestamp as etl_time
from order_details a
inner join order_header b on a.sales_order_id = b.sales_order_id 
)
SELECT *
from final_table
where 1=1
    {% if is_incremental() %}
    and MODIFIED_DATE::timestamp > (select max(MODIFIED_DATE) from sales_order_item_2011)
    or MODIFIED_DATE::timestamp > (select max(MODIFIED_DATE) from sales_order_item_2012)
    or MODIFIED_DATE::timestamp > (select max(MODIFIED_DATE) from sales_order_item_2013)
    or MODIFIED_DATE::timestamp > (select max(MODIFIED_DATE) from sales_order_item_2014)
    {% endif %}
